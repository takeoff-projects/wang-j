resource "google_project_service" "repo" {
  service = "sourcerepo.googleapis.com"
  disable_on_destroy = false
}
resource "google_project_service" "build" {
  service = "cloudbuild.googleapis.com"
  disable_on_destroy = false
}

// Set up google cloud side of github mirroring
resource "google_sourcerepo_repository" "message_store_repo" {
  name = "message-store"
  depends_on = [google_project_service.repo]
}

// This should already exist in our Projects
resource "google_pubsub_topic" "osr_import_topic" {
  name = "osr-import"
}

resource "google_cloudbuild_trigger" "build_message_store" {
  description = "Push to any branch"

  github {
    owner = "takeoff-projects"
    name = "wang-j"
    push {
      branch = ".*" //TODO: main eventually
    }
  }

  filename = "cloudbuild.yml"
}

resource "google_cloudfunctions_function" "osr_import_function" {
  name        = "osr-import-tracker"
  description = "Function to read OSR Import messages"
  runtime     = "go113"

  available_memory_mb   = 128
  timeout               = 60
  entry_point           = "main"
  
  // Unable to link a google cloud source repository with github in terraform, needs to be done via API or console

  event_trigger {
    event_type = "google.pubsub.topic.publish"
    resource = google_pubsub_topic.osr_import_topic.name
  }

  environment_variables = {
    MY_ENV_VAR = "my-env-var-value"
  }
}
